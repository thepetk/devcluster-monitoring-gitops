apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: ai-providers
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  resyncPeriod: 5m
  instanceSelector:
    matchLabels:
      dashboards: "grafana"
  folderRef: gitops
  json: >
    {
      "uid": "ai-providers",
      "title": "OpenAI Usage",
      "schemaVersion": 39,
      "version": 1,
      "refresh": "1m",
      "timezone": "browser",
      "panels": [
        {
          "type": "stat",
          "title": "Exporter Health",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "description": "Whether the robotheus exporter is running and being scraped by Prometheus. 1 = healthy, 0 = down.",
          "gridPos": { "x": 0, "y": 0, "w": 6, "h": 6 },
          "fieldConfig": {
            "defaults": {
              "mappings": [
                { "type": "value", "options": { "1": { "text": "UP", "color": "green" }, "0": { "text": "DOWN", "color": "red" } } }
              ],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "green", "value": 1 }] }
            }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "max(up{job=~\".*robotheus.*\"})",
              "instant": true
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "OpenAI Token Throughput",
          "description": "Rate of tokens (input + output combined) consumed across all OpenAI API calls, measured over a 5-minute rolling window.",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "gridPos": { "x": 6, "y": 0, "w": 18, "h": 9 },
          "fieldConfig": {
            "defaults": { "unit": "tokens/s", "custom": { "fillOpacity": 15 } }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(robotheus_openai_tokens_total[5m]))",
              "legendFormat": "tokens/s"
            }
          ]
        },
        {
          "type": "stat",
          "title": "Cost Today",
          "description": "Total OpenAI spend (USD) accumulated since midnight UTC, summed across all projects.",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "gridPos": { "x": 0, "y": 9, "w": 8, "h": 6 },
          "fieldConfig": {
            "defaults": {
              "unit": "currencyUSD",
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 10 }, { "color": "red", "value": 50 }] }
            }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(robotheus_openai_cost_usd_today)",
              "instant": true
            }
          ]
        },
        {
          "type": "stat",
          "title": "Cost This Week",
          "description": "Total OpenAI spend (USD) over the last 7 days, summed across all projects.",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "gridPos": { "x": 8, "y": 9, "w": 8, "h": 6 },
          "fieldConfig": {
            "defaults": {
              "unit": "currencyUSD",
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 50 }, { "color": "red", "value": 200 }] }
            }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(robotheus_openai_cost_usd_week)",
              "instant": true
            }
          ]
        },
        {
          "type": "stat",
          "title": "Cost This Month",
          "description": "Total OpenAI spend (USD) over the last 30 days, summed across all projects.",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "gridPos": { "x": 16, "y": 9, "w": 8, "h": 6 },
          "fieldConfig": {
            "defaults": {
              "unit": "currencyUSD",
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 200 }, { "color": "red", "value": 500 }] }
            }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(robotheus_openai_cost_usd_month)",
              "instant": true
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "OpenAI Tokens by Project",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "description": "Token consumption rate broken down by OpenAI project, showing which project is driving the most API usage.",
          "gridPos": { "x": 0, "y": 15, "w": 24, "h": 9 },
          "fieldConfig": {
            "defaults": { "unit": "tokens/s", "custom": { "fillOpacity": 15 } }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (project_id) (rate(robotheus_openai_tokens_total[5m]))",
              "legendFormat": "{{ project_id }}"
            }
          ]
        },
        {
          "type": "barchart",
          "title": "Weekly Cost by Project",
          "description": "Daily OpenAI spend per project over the last 7 days. Each bar represents one calendar day. Set the Grafana time range to 'Last 7 days' to restrict the visible dates.",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "gridPos": { "x": 0, "y": 24, "w": 12, "h": 9 },
          "options": {
            "xField": "date",
            "barWidth": 0.9,
            "groupWidth": 0.7,
            "stacking": "none",
            "legend": { "displayMode": "list", "placement": "bottom" }
          },
          "fieldConfig": {
            "defaults": { "unit": "currencyUSD" }
          },
          "transformations": [
            { "id": "labelsToFields", "options": { "mode": "columns" } }
          ],
          "targets": [
            {
              "refId": "A",
              "expr": "robotheus_openai_cost_usd_daily",
              "instant": true,
              "legendFormat": "{{ project }}"
            }
          ]
        },
        {
          "type": "barchart",
          "title": "Monthly Cost by Project",
          "description": "Daily OpenAI spend per project over the last 30 days. Each bar represents one calendar day. Set the Grafana time range to 'Last 30 days' to restrict the visible dates.",
          "datasource": { "type": "prometheus", "uid": "prometheus-user-workload" },
          "gridPos": { "x": 12, "y": 24, "w": 12, "h": 9 },
          "options": {
            "xField": "date",
            "barWidth": 0.9,
            "groupWidth": 0.7,
            "stacking": "none",
            "legend": { "displayMode": "list", "placement": "bottom" }
          },
          "fieldConfig": {
            "defaults": { "unit": "currencyUSD" }
          },
          "transformations": [
            { "id": "labelsToFields", "options": { "mode": "columns" } }
          ],
          "targets": [
            {
              "refId": "A",
              "expr": "robotheus_openai_cost_usd_daily",
              "instant": true,
              "legendFormat": "{{ project }}"
            }
          ]
        }
      ]
    }
